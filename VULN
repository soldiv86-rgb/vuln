-- Auto favorite state
local autoFavorite = false
local petId = "{9c8926b2-0362-4019-85e7-905ea7a8433a}"

-- Start auto-favoriting loop
local function startAutoFavorite()
    if autoFavorite then return end
    autoFavorite = true
    spawn(function()
        while autoFavorite do
            local item = game.Players.LocalPlayer.Backpack:FindFirstChild("Carrot [0.38kg]")
            if item then
                game.ReplicatedStorage.GameEvents.Favorite_Item:FireServer(item)
            end
            wait(0.2)
        end
    end)
end

-- Stop auto-favoriting loop
local function stopAutoFavorite()
    autoFavorite = false
end

-- Hook PetsService:FireServer to handle dynamic CFrame and auto loop
local PetsService = game.ReplicatedStorage.GameEvents.PetsService
local oldFireServer = PetsService.FireServer

PetsService.FireServer = function(self, action, id, cframe)
    -- Dynamically get CFrame if not provided or incorrect
    local finalCFrame = cframe
    if action == "EquipPet" and id == petId then
        -- Try to get the pet's current CFrame from Backpack or Character
        local player = game.Players.LocalPlayer
        local pet = player.Backpack:FindFirstChild(id) or player.Character:FindFirstChild(id)
        if pet and pet.PrimaryPart then
            finalCFrame = pet.PrimaryPart.CFrame
        else
            finalCFrame = CFrame.new() -- fallback
        end
    end

    -- Call original FireServer
    oldFireServer(self, action, id, finalCFrame)

    -- Auto loop control
    if id == petId then
        if action == "EquipPet" then
            startAutoFavorite()
        elseif action == "UnequipPet" then
            stopAutoFavorite()
        end
    end
end
